"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validatelogin = exports.userImplant = exports.loginCheck = void 0;
var _passport = _interopRequireDefault(require("passport"));
var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));
var _config = _interopRequireDefault(require("../config"));
var JWTSign = function JWTSign(user, date) {
  return _jsonwebtoken["default"].sign({
    // iss : config.app.name,
    sub: user.id,
    iat: date.getTime(),
    exp: new Date().setMinutes(date.getMinutes() + 30)
  }, process.env.JWT_SECRET);
};
var loginCheck = function loginCheck() {
  return function (req, res, next) {
    var token = null;
    if (req && req.cookies) {
      token = req.cookies['XSRF-token'];
    }
    if (token != null) {
      return res.redirect('/');
    }
    next();
  };
};
exports.loginCheck = loginCheck;
var validatelogin = function validatelogin(req, res, next) {
  _passport["default"].authenticate('jwt', {
    session: false
  }, function (err, user, info) {
    var contype = req.headers['content-type'];
    var json = !(!contype || contype.indexOf('application/json') !== 0);
    if (err && err == 'expired') {
      next();
      return;
    }
    if (err && err == 'invalid') {
      next();
      return;
    }
    if (err && err == 'user') {
      next();
      return;
    }
    if (err && Object.keys(err).length) {
      next();
      return;
    }
    if (err) {
      next();
      return;
    }
    if (!user) {
      next();
      return;
    }

    //Update Token
    var date = new Date();
    var token = JWTSign(user, date);
    res.cookie('XSRF-token', token, {
      expire: new Date().setMinutes(date.getMinutes() + 30),
      httpOnly: true,
      secure: true
    });
    req.user = user;
    next();
  })(req, res, next);
};
exports.validatelogin = validatelogin;
var userImplant = function userImplant(req, res, next) {
  res.locals.user = req.user;
  next();
};
exports.userImplant = userImplant;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcGFzc3BvcnQiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9qc29ud2VidG9rZW4iLCJfY29uZmlnIiwiSldUU2lnbiIsInVzZXIiLCJkYXRlIiwiSldUIiwic2lnbiIsInN1YiIsImlkIiwiaWF0IiwiZ2V0VGltZSIsImV4cCIsIkRhdGUiLCJzZXRNaW51dGVzIiwiZ2V0TWludXRlcyIsInByb2Nlc3MiLCJlbnYiLCJKV1RfU0VDUkVUIiwibG9naW5DaGVjayIsInJlcSIsInJlcyIsIm5leHQiLCJ0b2tlbiIsImNvb2tpZXMiLCJyZWRpcmVjdCIsImV4cG9ydHMiLCJ2YWxpZGF0ZWxvZ2luIiwicGFzc3BvcnQiLCJhdXRoZW50aWNhdGUiLCJzZXNzaW9uIiwiZXJyIiwiaW5mbyIsImNvbnR5cGUiLCJoZWFkZXJzIiwianNvbiIsImluZGV4T2YiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiY29va2llIiwiZXhwaXJlIiwiaHR0cE9ubHkiLCJzZWN1cmUiLCJ1c2VySW1wbGFudCIsImxvY2FscyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2F1dGguanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhc3Nwb3J0IGZyb20gJ3Bhc3Nwb3J0JztcclxuaW1wb3J0IEpXVCBmcm9tICdqc29ud2VidG9rZW4nO1xyXG5pbXBvcnQgY29uZmlnIGZyb20gJy4uL2NvbmZpZyc7XHJcblxyXG5jb25zdCBKV1RTaWduID0gZnVuY3Rpb24odXNlciwgZGF0ZSl7XHJcbiAgICByZXR1cm4gSldULnNpZ24oe1xyXG4gICAgICAgIC8vIGlzcyA6IGNvbmZpZy5hcHAubmFtZSxcclxuICAgICAgICBzdWIgOiB1c2VyLmlkLFxyXG4gICAgICAgIGlhdCA6IGRhdGUuZ2V0VGltZSgpLFxyXG4gICAgICAgIGV4cCA6IG5ldyBEYXRlKCkuc2V0TWludXRlcyhkYXRlLmdldE1pbnV0ZXMoKSArIDMwKVxyXG4gICAgfSwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCk7XHJcbn1cclxuZXhwb3J0IGNvbnN0IGxvZ2luQ2hlY2sgPSAoKSA9PiB7XHJcbiAgICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgICAgdmFyIHRva2VuID0gbnVsbDsgICBcclxuICAgICAgICBpZiAocmVxICYmIHJlcS5jb29raWVzKXtcclxuICAgICAgICAgICAgdG9rZW4gPSByZXEuY29va2llc1snWFNSRi10b2tlbiddO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZih0b2tlbiAhPSBudWxsKXtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5yZWRpcmVjdCgnLycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBuZXh0KCk7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0IGNvbnN0IHZhbGlkYXRlbG9naW4gPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZSgnand0Jywge3Nlc3Npb246IGZhbHNlfSwgKGVyciwgdXNlciwgaW5mbykgPT4ge1xyXG4gICAgICAgIGxldCBjb250eXBlID0gcmVxLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddO1xyXG4gICAgICAgIHZhciBqc29uID0gISghY29udHlwZSB8fCBjb250eXBlLmluZGV4T2YoJ2FwcGxpY2F0aW9uL2pzb24nKSAhPT0gMCk7XHJcbiAgICAgICAgaWYgKGVyciAmJiBlcnIgPT0gJ2V4cGlyZWQnKXsgbmV4dCgpO3JldHVybiA7IH1cclxuICAgICAgICBpZiAoZXJyICYmIGVyciA9PSAnaW52YWxpZCcpeyBuZXh0KCk7cmV0dXJuIDsgfVxyXG4gICAgICAgIGlmIChlcnIgJiYgZXJyID09ICd1c2VyJyl7IG5leHQoKTtyZXR1cm4gO31cclxuICAgICAgICBpZiAoZXJyICYmIE9iamVjdC5rZXlzKGVycikubGVuZ3RoKSB7IG5leHQoKTtyZXR1cm4gO31cclxuICAgICAgICBpZiAoZXJyKSB7IG5leHQoKTtyZXR1cm4gO31cclxuICAgICAgICBpZiAoIXVzZXIpIHsgbmV4dCgpO3JldHVybiA7fVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vVXBkYXRlIFRva2VuXHJcbiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIHZhciB0b2tlbiA9IEpXVFNpZ24odXNlciwgZGF0ZSk7XHJcbiAgICAgICAgcmVzLmNvb2tpZSgnWFNSRi10b2tlbicsIHRva2VuLCB7XHJcbiAgICAgICAgICAgIGV4cGlyZTogbmV3IERhdGUoKS5zZXRNaW51dGVzKGRhdGUuZ2V0TWludXRlcygpICsgMzApLFxyXG4gICAgICAgICAgICBodHRwT25seTogdHJ1ZSwgc2VjdXJlOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcS51c2VyID0gdXNlcjtcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICB9KShyZXEsIHJlcywgbmV4dCk7XHJcbn07XHJcblxyXG5leHBvcnQgdmFyIHVzZXJJbXBsYW50ID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICByZXMubG9jYWxzLnVzZXIgPSByZXEudXNlcjtcclxuICAgIG5leHQoKTtcclxufSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQUFBLFNBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLGFBQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUVBLElBQU1HLE9BQU8sR0FBRyxTQUFWQSxPQUFPQSxDQUFZQyxJQUFJLEVBQUVDLElBQUksRUFBQztFQUNoQyxPQUFPQyx3QkFBRyxDQUFDQyxJQUFJLENBQUM7SUFDWjtJQUNBQyxHQUFHLEVBQUdKLElBQUksQ0FBQ0ssRUFBRTtJQUNiQyxHQUFHLEVBQUdMLElBQUksQ0FBQ00sT0FBTyxDQUFDLENBQUM7SUFDcEJDLEdBQUcsRUFBRyxJQUFJQyxJQUFJLENBQUMsQ0FBQyxDQUFDQyxVQUFVLENBQUNULElBQUksQ0FBQ1UsVUFBVSxDQUFDLENB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